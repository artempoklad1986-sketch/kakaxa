<?php
mb_internal_encoding('UTF-8');
date_default_timezone_set('Europe/Moscow');
session_start();

$BASE = __DIR__;
$configFile = $BASE.'/config.json';
$aiKnowledgeFile = $BASE.'/ai_knowledge.json';
$aiTrainingFile = $BASE.'/ai_training.json';
$aiContextFile = $BASE.'/ai_context.json';
$aiStatsFile = $BASE.'/ai_stats.json';
$chatLog = $BASE.'/chat_log.txt';
$uploadsDir = $BASE.'/uploads';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è
$cfg = json_decode(@file_get_contents($configFile), true);
if (!$cfg || !isset($cfg['admin_pass'])) {
  die('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (empty($_SESSION['ai_admin']) && !isset($_POST['ai_admin_login'])) {
  showLoginForm();
  exit;
}

if (isset($_POST['ai_admin_login'])) {
  $pass = $_POST['password'] ?? '';
  if (hash_equals($cfg['admin_pass'], $pass)) {
    $_SESSION['ai_admin'] = true;
    header('Location: ai_admin.php');
    exit;
  } else {
    showLoginForm('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    exit;
  }
}

// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
if (isset($_POST['upload_training_file'])) {
  if (isset($_FILES['training_file']) && $_FILES['training_file']['error'] === 0) {
    $uploadedFile = $_FILES['training_file'];
    $filename = $uploadedFile['name'];
    $tmpPath = $uploadedFile['tmp_name'];
    $fileExt = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

    // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
    $content = file_get_contents($tmpPath);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ UTF-8
    $encoding = mb_detect_encoding($content, ['UTF-8', 'Windows-1251', 'CP1251', 'ISO-8859-1'], true);
    if ($encoding && $encoding !== 'UTF-8') {
      $content = mb_convert_encoding($content, 'UTF-8', $encoding);
    }

    $processedCount = 0;
    $message = '';

    try {
      if ($fileExt === 'txt' || $fileExt === 'md') {
        $processedCount = processTextFileImproved($content, $filename);
        $message = "–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ $processedCount –∑–∞–ø–∏—Å–µ–π.";
      } elseif ($fileExt === 'json') {
        $processedCount = processJsonFileImproved($content);
        $message = "JSON —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ $processedCount –∑–∞–ø–∏—Å–µ–π.";
      } elseif ($fileExt === 'csv') {
        $processedCount = processCsvFileImproved($content);
        $message = "CSV —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ $processedCount –∑–∞–ø–∏—Å–µ–π.";
      } elseif ($fileExt === 'docx' || $fileExt === 'doc') {
        $message = "DOCX/DOC —Ñ–∞–π–ª—ã –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ TXT.";
      } else {
        $message = "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: $fileExt";
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –¥–ª—è –∞—Ä—Ö–∏–≤–∞
      if ($processedCount > 0) {
        $archiveFile = $uploadsDir . '/ai_archive_' . date('Y-m-d_H-i-s') . '_' . $filename;
        copy($tmpPath, $archiveFile);
      }

    } catch (Exception $e) {
      $message = "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: " . $e->getMessage();
    }

    header('Location: ai_admin.php?upload_result=' . urlencode($message));
    exit;
  }
}

// –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
if (isset($_POST['quick_add_knowledge'])) {
  $question = trim($_POST['question'] ?? '');
  $answer = trim($_POST['answer'] ?? '');
  $category = trim($_POST['category'] ?? 'custom');

  if ($question && $answer) {
    $knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];

    if (!isset($knowledge[$category])) {
      $knowledge[$category] = [];
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç
    $key = mb_strtolower(str_replace(['?', '!', '.'], '', $question));
    $knowledge[$category][$key] = $answer;

    file_put_contents($aiKnowledgeFile, json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $training = json_decode(@file_get_contents($aiTrainingFile), true) ?: ['conversations' => [], 'user_feedback' => [], 'learning_patterns' => [], 'context_memory' => []];

    $training['conversations'][] = [
      'timestamp' => date('Y-m-d H:i:s'),
      'user_message' => $question,
      'ai_response' => $answer,
      'feedback' => 5,
      'context' => ['manual_add'],
      'source' => 'admin_quick_add'
    ];

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    $keywords = extractKeywordsFromText($question);
    foreach($keywords as $keyword) {
      if (!isset($training['learning_patterns'][$keyword])) {
        $training['learning_patterns'][$keyword] = [];
      }
      $training['learning_patterns'][$keyword][] = $answer;
    }

    file_put_contents($aiTrainingFile, json_encode($training, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

    header('Location: ai_admin.php?quick_added=1');
    exit;
  }
}

// –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
if (isset($_POST['bulk_add_knowledge'])) {
  $bulkText = trim($_POST['bulk_text'] ?? '');

  if ($bulkText) {
    $processedCount = processBulkText($bulkText);
    header('Location: ai_admin.php?bulk_result=' . urlencode("–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ $processedCount –∑–∞–ø–∏—Å–µ–π"));
    exit;
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
if (isset($_POST['update_knowledge'])) {
  $newKnowledge = json_decode($_POST['knowledge_data'], true);
  if ($newKnowledge) {
    file_put_contents($aiKnowledgeFile, json_encode($newKnowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats('knowledge_updates');

    header('Location: ai_admin.php?updated=1');
    exit;
  }
}

// –°–±—Ä–æ—Å –æ–±—É—á–µ–Ω–∏—è
if (isset($_POST['reset_training'])) {
  $defaultTraining = [
    'conversations' => [],
    'user_feedback' => [],
    'learning_patterns' => [],
    'context_memory' => []
  ];
  file_put_contents($aiTrainingFile, json_encode($defaultTraining, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

  $defaultStats = [
    'total_conversations' => 0,
    'successful_responses' => 0,
    'learning_events' => 0,
    'user_satisfaction' => 0,
    'knowledge_updates' => 0
  ];
  file_put_contents($aiStatsFile, json_encode($defaultStats, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

  header('Location: ai_admin.php?reset=1');
  exit;
}

// –£–õ–£–ß–®–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò

function processTextFileImproved($content, $filename) {
  global $aiKnowledgeFile, $aiTrainingFile;

  $knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];
  $training = json_decode(@file_get_contents($aiTrainingFile), true) ?: ['conversations' => [], 'user_feedback' => [], 'learning_patterns' => [], 'context_memory' => []];

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
  $category = 'imported_' . pathinfo($filename, PATHINFO_FILENAME);
  $category = preg_replace('/[^a-zA-Z0-9_]/', '_', $category);

  if (!isset($knowledge[$category])) {
    $knowledge[$category] = [];
  }

  $lines = explode("\n", $content);
  $processedCount = 0;
  $currentQuestion = '';
  $currentAnswer = '';

  foreach ($lines as $line) {
    $line = trim($line);
    if (empty($line) || $line[0] === '#') continue;

    // –†–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
    // 1. "–í–æ–ø—Ä–æ—Å: –û—Ç–≤–µ—Ç"
    // 2. "Q: A:"
    // 3. "- –í–æ–ø—Ä–æ—Å\n- –û—Ç–≤–µ—Ç"
    // 4. –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–Ω–∞–Ω–∏–µ)

    if (preg_match('/^(.+?):\s*(.+)$/u', $line, $matches)) {
      // –§–æ—Ä–º–∞—Ç "–∫–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ"
      $key = mb_strtolower(trim($matches[1]));
      $value = trim($matches[2]);

      $knowledge[$category][$key] = $value;

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      addToTraining($training, $matches[1], $value, 'file_import');
      $processedCount++;

    } elseif (preg_match('/^[Q–í]:\s*(.+)$/ui', $line, $matches)) {
      // –í–æ–ø—Ä–æ—Å
      $currentQuestion = trim($matches[1]);

    } elseif (preg_match('/^[A–û]:\s*(.+)$/ui', $line, $matches) && $currentQuestion) {
      // –û—Ç–≤–µ—Ç
      $currentAnswer = trim($matches[1]);

      $key = mb_strtolower(str_replace(['?', '!', '.'], '', $currentQuestion));
      $knowledge[$category][$key] = $currentAnswer;

      addToTraining($training, $currentQuestion, $currentAnswer, 'file_import');
      $processedCount++;

      $currentQuestion = '';
      $currentAnswer = '';

    } elseif (strpos($line, '-') === 0) {
      // –§–æ—Ä–º–∞—Ç —Å–ø–∏—Å–∫–∞
      $text = trim(substr($line, 1));
      if ($currentQuestion === '') {
        $currentQuestion = $text;
      } else {
        $key = mb_strtolower(str_replace(['?', '!', '.'], '', $currentQuestion));
        $knowledge[$category][$key] = $text;

        addToTraining($training, $currentQuestion, $text, 'file_import');
        $processedCount++;

        $currentQuestion = '';
      }

    } elseif (mb_strlen($line) > 10) {
      // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—â–µ–µ –∑–Ω–∞–Ω–∏–µ
      $knowledge[$category][] = $line;
      $processedCount++;
    }
  }

  file_put_contents($aiKnowledgeFile, json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
  file_put_contents($aiTrainingFile, json_encode($training, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

  updateStats('knowledge_updates');

  return $processedCount;
}

function processJsonFileImproved($content) {
  global $aiKnowledgeFile;

  $data = json_decode($content, true);
  if (!$data) {
    throw new Exception('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç');
  }

  $knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];
  $processedCount = 0;

  // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º JSON
  function processJsonData($data, &$knowledge, $prefix = 'imported', &$count) {
    foreach ($data as $key => $value) {
      if (is_array($value)) {
        if (isset($value[0]) && is_string($value[0])) {
          // –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
          $knowledge[$prefix][$key] = $value;
          $count += count($value);
        } else {
          // –í–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
          processJsonData($value, $knowledge, $prefix . '_' . $key, $count);
        }
      } else {
        // –ü—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        $knowledge[$prefix][$key] = $value;
        $count++;
      }
    }
  }

  processJsonData($data, $knowledge, 'imported', $processedCount);

  file_put_contents($aiKnowledgeFile, json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
  updateStats('knowledge_updates');

  return $processedCount;
}

function processCsvFileImproved($content) {
  global $aiTrainingFile, $aiKnowledgeFile;

  $lines = str_getcsv($content, "\n");
  $training = json_decode(@file_get_contents($aiTrainingFile), true) ?: ['conversations' => [], 'user_feedback' => [], 'learning_patterns' => [], 'context_memory' => []];
  $knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];

  if (!isset($knowledge['csv_import'])) {
    $knowledge['csv_import'] = [];
  }

  $processedCount = 0;
  $headers = null;

  foreach ($lines as $index => $line) {
    $data = str_getcsv($line);

    if ($index === 0 && (in_array('–≤–æ–ø—Ä–æ—Å', array_map('mb_strtolower', $data)) || in_array('question', array_map('mb_strtolower', $data)))) {
      // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏
      $headers = array_map('mb_strtolower', $data);
      continue;
    }

    if (count($data) >= 2) {
      $question = trim($data[0]);
      $answer = trim($data[1]);
      $rating = isset($data[2]) ? (int)$data[2] : 5;

      if ($question && $answer) {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
        $key = mb_strtolower(str_replace(['?', '!', '.'], '', $question));
        $knowledge['csv_import'][$key] = $answer;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        addToTraining($training, $question, $answer, 'csv_import', $rating);
        $processedCount++;
      }
    }
  }

  file_put_contents($aiKnowledgeFile, json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
  file_put_contents($aiTrainingFile, json_encode($training, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

  updateStats('knowledge_updates');

  return $processedCount;
}

function processBulkText($text) {
  global $aiKnowledgeFile, $aiTrainingFile;

  $knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];
  $training = json_decode(@file_get_contents($aiTrainingFile), true) ?: ['conversations' => [], 'user_feedback' => [], 'learning_patterns' => [], 'context_memory' => []];

  if (!isset($knowledge['bulk_add'])) {
    $knowledge['bulk_add'] = [];
  }

  // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–ª–æ–∫–∏ –ø–æ –ø—É—Å—Ç—ã–º —Å—Ç—Ä–æ–∫–∞–º
  $blocks = preg_split('/\n\s*\n/', $text);
  $processedCount = 0;

  foreach ($blocks as $block) {
    $lines = array_filter(array_map('trim', explode("\n", $block)));

    if (count($lines) >= 2) {
      // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –≤–æ–ø—Ä–æ—Å, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –æ—Ç–≤–µ—Ç
      $question = array_shift($lines);
      $answer = implode(' ', $lines);

      $key = mb_strtolower(str_replace(['?', '!', '.'], '', $question));
      $knowledge['bulk_add'][$key] = $answer;

      addToTraining($training, $question, $answer, 'bulk_add');
      $processedCount++;

    } elseif (count($lines) === 1 && mb_strlen($lines[0]) > 10) {
      // –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–∫—Ç
      $knowledge['bulk_add'][] = $lines[0];
      $processedCount++;
    }
  }

  file_put_contents($aiKnowledgeFile, json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
  file_put_contents($aiTrainingFile, json_encode($training, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));

  updateStats('knowledge_updates');

  return $processedCount;
}

function addToTraining(&$training, $question, $answer, $source, $rating = 5) {
  $training['conversations'][] = [
    'timestamp' => date('Y-m-d H:i:s'),
    'user_message' => $question,
    'ai_response' => $answer,
    'feedback' => $rating,
    'context' => [$source],
    'source' => $source
  ];

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  $keywords = extractKeywordsFromText($question);
  foreach($keywords as $keyword) {
    if (!isset($training['learning_patterns'][$keyword])) {
      $training['learning_patterns'][$keyword] = [];
    }
    $training['learning_patterns'][$keyword][] = $answer;
  }
}

function extractKeywordsFromText($text) {
  $text = mb_strtolower($text);
  $keywords = [];

  // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏
  $patterns = [
    '—Ü–µ–Ω–∞|—Å—Ç–æ–∏–º–æ—Å—Ç—å|—Å–∫–æ–ª—å–∫–æ|—Ü–µ–Ω—É|—Ç–∞—Ä–∏—Ñ|–ø—Ä–∞–π—Å' => 'price',
    '–≤—Ä–µ–º—è|—Å—Ä–æ–∫|–±—ã—Å—Ç—Ä–æ|–¥–æ–ª–≥–æ|–∫–æ–≥–¥–∞|–≥–æ—Ç–æ–≤–æ' => 'time',
    '–¥–æ—Å—Ç–∞–≤–∫–∞|–ø—Ä–∏–≤–µ–∑—Ç–∏|–∫—É—Ä—å–µ—Ä|–¥–æ—Å—Ç–∞–≤–∏—Ç—å' => 'delivery',
    '—Ñ–∞–π–ª|—Ñ–æ—Ä–º–∞—Ç|–º–∞–∫–µ—Ç|pdf|jpg|—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è' => 'files',
    '–≤–∏–∑–∏—Ç–∫–∏|–≤–∏–∑–∏—Ç–∫–∞|–∫–∞—Ä—Ç–æ—á–∫–∏' => 'cards',
    '–±–∞–Ω–Ω–µ—Ä|–±–∞–Ω–Ω–µ—Ä—ã|—Ä–∞—Å—Ç—è–∂–∫–∞' => 'banner',
    '—Ñ–æ—Ç–æ|—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è|—Å–Ω–∏–º–æ–∫|–¥–æ–∫—É–º–µ–Ω—Ç—ã' => 'photo',
    '–ø–µ—á–∞—Ç—å|—Ä–∞—Å–ø–µ—á–∞—Ç–∫–∞|–ø–µ—á–∞—Ç–∞—Ç—å' => 'printing',
    '—à—Ç–∞–º–ø|–ø–µ—á–∞—Ç—å|—à—Ç–∞–º–ø—ã' => 'stamp',
    '–ª–∏—Å—Ç–æ–≤–∫–∏|–ª–∏—Å—Ç–æ–≤–∫–∞|—Ñ–ª–∞–µ—Ä—ã' => 'flyers',
    '–∫–∞—á–µ—Å—Ç–≤–æ|—Ö–æ—Ä–æ—à–æ|–ø–ª–æ—Ö–æ|–æ—Ç–ª–∏—á–Ω–æ' => 'quality',
    '—Ä–∞–∑–º–µ—Ä|—Ñ–æ—Ä–º–∞—Ç|–≥–∞–±–∞—Ä–∏—Ç—ã' => 'size',
    '–º–∞—Ç–µ—Ä–∏–∞–ª|–±—É–º–∞–≥–∞|–ø–ª–µ–Ω–∫–∞' => 'material'
  ];

  foreach($patterns as $pattern => $keyword) {
    if (preg_match("/($pattern)/ui", $text)) {
      $keywords[] = $keyword;
    }
  }

  return array_unique($keywords);
}

function updateStats($field) {
  global $aiStatsFile;

  $stats = json_decode(@file_get_contents($aiStatsFile), true) ?: [
    'total_conversations' => 0,
    'successful_responses' => 0,
    'learning_events' => 0,
    'user_satisfaction' => 0,
    'knowledge_updates' => 0
  ];

  if (isset($stats[$field])) {
    $stats[$field]++;
  }

  file_put_contents($aiStatsFile, json_encode($stats, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT));
}

function showLoginForm($error = '') {
  echo '<!doctype html><html><head><meta charset="utf-8"><title>AI Admin Login</title><style>body{font-family:system-ui;background:#0f1115;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}.login-card{background:#1a1f2b;padding:30px;border-radius:12px;width:300px;text-align:center}.error{color:#ff7a7a;margin-bottom:15px}input{width:100%;padding:12px;border:1px solid #333;background:#252a38;color:#fff;border-radius:6px;margin-bottom:15px}button{width:100%;padding:12px;background:#FF8A00;border:none;border-radius:6px;color:#000;font-weight:600;cursor:pointer}</style></head><body><div class="login-card"><h2>ü§ñ AI Admin Panel</h2>';
  if ($error) echo '<div class="error">'.$error.'</div>';
  echo '<form method="post"><input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" required><button name="ai_admin_login">–í–æ–π—Ç–∏ –≤ AI –∞–¥–º–∏–Ω–∫—É</button></form></div></body></html>';
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
$knowledge = json_decode(@file_get_contents($aiKnowledgeFile), true) ?: [];
$training = json_decode(@file_get_contents($aiTrainingFile), true) ?: ['conversations' => [], 'user_feedback' => [], 'learning_patterns' => [], 'context_memory' => []];
$context = json_decode(@file_get_contents($aiContextFile), true) ?: [];
$stats = json_decode(@file_get_contents($aiStatsFile), true) ?: ['total_conversations' => 0, 'successful_responses' => 0, 'learning_events' => 0, 'user_satisfaction' => 0, 'knowledge_updates' => 0];

// –ß–∏—Ç–∞–µ–º –ª–æ–≥–∏ —á–∞—Ç–∞
$chatLines = @file($chatLog, FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES) ?: [];
$recentChats = [];
foreach (array_reverse(array_slice($chatLines, -50)) as $line) {
  if (preg_match('~^$$(.+?)$$\s*(.+)$~u', $line, $m)) {
    $data = json_decode($m[2], true);
    if ($data && isset($data['type']) && $data['type'] === 'ai_chat') {
      $recentChats[] = ['time' => $m[1], 'data' => $data];
    }
  }
}
?>
<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>ü§ñ AI Admin Panel - –£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–ò</title>
  <style>
    :root{--bg:#0f1115;--panel:#1a1f2b;--panel2:#252a38;--muted:#8a92a5;--brand:#FFD700;--accent:#2D5BFF;--ok:#4ade80;--bad:#f87171;--text:#e9eef7;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6}
    .wrap{max-width:1600px;margin:0 auto;padding:20px}
    .header{background:linear-gradient(135deg,#FF8A00,#FFB14D);color:#000;padding:20px;border-radius:12px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 50%);animation:shimmer 6s ease-in-out infinite}
    @keyframes shimmer{0%,100%{transform:rotate(0deg)}50%{transform:rotate(180deg)}}
    .header h1{margin:0;font-size:32px;font-weight:900;position:relative;z-index:2}
    .header p{margin:8px 0 0;opacity:0.9;position:relative;z-index:2;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:all 0.3s}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.2)}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);font-weight:700;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(45,91,255,.1))}
    .card-body{padding:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
    .stat-item{background:var(--panel2);padding:16px;border-radius:8px;text-align:center;border:1px solid var(--border)}
    .stat-number{font-size:28px;font-weight:900;color:var(--brand);text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .stat-label{font-size:12px;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:0.5px}
    .btn{background:linear-gradient(135deg,var(--brand),#FFA500);border:none;color:#000;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;border:2px solid transparent}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,215,0,0.4);border-color:rgba(255,255,255,.3)}
    .btn-accent{background:linear-gradient(135deg,var(--accent),#0066ff);color:#fff}
    .btn-accent:hover{box-shadow:0 6px 20px rgba(45,91,255,0.4)}
    .btn-danger{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn-danger:hover{box-shadow:0 6px 20px rgba(220,38,38,0.4)}
    .btn-success{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff}
    .btn-success:hover{box-shadow:0 6px 20px rgba(22,163,74,0.4)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--brand)}
    input,textarea,select{width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:6px;font-size:14px;transition:all 0.2s}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,215,0,0.1);outline:none}
    textarea{min-height:120px;resize:vertical;font-family:Monaco,monospace;font-size:13px}
    .upload-area{border:3px dashed var(--border);border-radius:12px;padding:40px;text-align:center;margin:12px 0;transition:all 0.3s;background:linear-gradient(135deg,rgba(255,215,0,.02),rgba(45,91,255,.02));cursor:pointer;position:relative;overflow:hidden}
    .upload-area::before{content:'üìÅ';position:absolute;top:20px;right:20px;font-size:24px;opacity:0.3}
    .upload-area:hover{border-color:var(--brand);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(45,91,255,.05));transform:translateY(-2px)}
    .upload-area.dragover{border-color:var(--accent);background:rgba(45,91,255,.1);transform:scale(1.02)}
    .upload-area input[type=file]{display:none}
    .upload-icon{font-size:48px;margin-bottom:12px;opacity:0.7}
    .upload-text{font-size:16px;font-weight:600;margin-bottom:8px;color:var(--brand)}
    .upload-hint{font-size:14px;opacity:0.8;line-height:1.4}
    .chat-log{max-height:400px;overflow-y:auto;background:var(--panel2);border-radius:8px;padding:12px;border:1px solid var(--border)}
    .chat-item{margin:8px 0;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.03);border-left:3px solid var(--brand)}
    .chat-user{color:#60a5fa;font-weight:600;margin-bottom:4px}
    .chat-ai{color:#fbbf24;margin-bottom:4px}
    .chat-time{font-size:11px;color:var(--muted)}
    .knowledge-editor{font-family:Monaco,monospace;font-size:13px;height:350px;background:var(--panel2);border:1px solid var(--border);border-radius:6px;line-height:1.4}
    .alert{padding:14px 18px;border-radius:8px;margin-bottom:16px;border-left:4px solid;font-weight:500}
    .alert-success{background:rgba(74,222,128,0.1);color:var(--ok);border-left-color:var(--ok)}
    .alert-info{background:rgba(45,91,255,0.1);color:var(--accent);border-left-color:var(--accent)}
    .alert-warning{background:rgba(245,158,11,0.1);color:#f59e0b;border-left-color:#f59e0b}
    .progress-bar{width:100%;height:8px;background:var(--panel2);border-radius:4px;overflow:hidden;margin:8px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--brand),#FFA500);transition:width 0.3s}
    .mini{font-size:11px;color:var(--muted)}
    .mt-1{margin-top:8px}.mb-1{margin-bottom:8px}.text-center{text-align:center}
    .knowledge-preview{max-height:200px;overflow-y:auto;background:var(--panel2);padding:12px;border-radius:6px;font-size:12px;line-height:1.4;border:1px solid var(--border)}
    .knowledge-item{margin:4px 0;padding:6px 8px;background:rgba(255,215,0,0.1);border-radius:4px;border-left:2px solid var(--brand)}
    .quick-examples{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
    .example-btn{background:var(--panel2);border:1px solid var(--border);padding:10px;border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:13px;text-align:left}
    .example-btn:hover{background:rgba(255,215,0,0.1);border-color:var(--brand)}
    .tab-container{margin-bottom:20px}
    .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:20px;background:var(--panel2);border-radius:8px 8px 0 0;overflow:hidden}
    .tab{padding:14px 24px;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s;font-weight:600;background:rgba(255,255,255,.02)}
    .tab.active{border-bottom-color:var(--brand);color:var(--brand);background:rgba(255,215,0,.1)}
    .tab:hover{background:rgba(255,215,0,0.05)}
    .tab-content{display:none;background:var(--panel2);padding:20px;border-radius:0 0 8px 8px}
    .tab-content.active{display:block}
  </style>
</head>
<body>
  <div class='wrap'>
    <div class='header'>
      <h1>ü§ñ AI Admin Panel v2.1</h1>
      <p>–£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º ‚Ä¢ –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–Ω–∞–Ω–∏–π ‚Ä¢ –ú–æ—â–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
    </div>

    <?php if (isset($_GET['upload_result'])): ?>
      <div class='alert alert-success'>‚úÖ <?=htmlspecialchars($_GET['upload_result'])?></div>
    <?php endif; ?>

    <?php if (isset($_GET['quick_added'])): ?>
      <div class='alert alert-success'>‚úÖ –ó–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –ò–ò –æ–±—É—á–µ–Ω!</div>
    <?php endif; ?>

    <?php if (isset($_GET['bulk_result'])): ?>
      <div class='alert alert-success'>‚úÖ <?=htmlspecialchars($_GET['bulk_result'])?></div>
    <?php endif; ?>

    <?php if (isset($_GET['updated'])): ?>
      <div class='alert alert-success'>‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div>
    <?php endif; ?>

    <?php if (isset($_GET['reset'])): ?>
      <div class='alert alert-info'>üîÑ –î–∞–Ω–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã. –ò–ò –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ.</div>
    <?php endif; ?>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ò–ò -->
    <div class='card' style='margin-bottom:20px'>
      <div class='card-header'>
        üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ò–ò
        <span class='mini'>–û–±–Ω–æ–≤–ª–µ–Ω–æ: <?=date('Y-m-d H:i:s')?></span>
      </div>
      <div class='card-body'>
        <div class='stats-grid'>
          <div class='stat-item'>
            <div class='stat-number'><?=number_format($stats['total_conversations'])?></div>
            <div class='stat-label'>–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤</div>
          </div>
          <div class='stat-item'>
            <div class='stat-number'><?=count($training['learning_patterns'])?></div>
            <div class='stat-label'>–í—ã—É—á–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</div>
          </div>
          <div class='stat-item'>
            <div class='stat-number'><?=count($knowledge)?></div>
            <div class='stat-label'>–†–∞–∑–¥–µ–ª–æ–≤ –∑–Ω–∞–Ω–∏–π</div>
          </div>
          <div class='stat-item'>
            <div class='stat-number'><?=$stats['learning_events']?></div>
            <div class='stat-label'>–°–æ–±—ã—Ç–∏—è –æ–±—É—á–µ–Ω–∏—è</div>
          </div>
          <div class='stat-item'>
            <div class='stat-number'><?=count($training['conversations'])?></div>
            <div class='stat-label'>–ó–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
          </div>
          <div class='stat-item'>
            <div class='stat-number'><?=count($recentChats)?></div>
            <div class='stat-label'>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —á–∞—Ç—ã</div>
          </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è -->
        <div class='mb-1'><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è:</strong></div>
        <div class='progress-bar'>
          <div class='progress-fill' style='width:<?=min(100, ($stats['total_conversations'] / 100) * 100)?>%'></div>
        </div>
        <div class='mini mt-1'>–ò–ò –æ—Å–≤–æ–∏–ª <?=min(100, intval(($stats['total_conversations'] / 100) * 100))?>% –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è ‚Ä¢ –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º –¥–∏–∞–ª–æ–≥–∞–º</div>
      </div>
    </div>

    <div class='tab-container'>
      <div class='tabs'>
        <div class='tab active' onclick='switchTab("upload")'>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</div>
        <div class='tab' onclick='switchTab("quick")'>‚ö° –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div>
        <div class='tab' onclick='switchTab("bulk")'>üìù –ú–∞—Å—Å–æ–≤—ã–π –≤–≤–æ–¥</div>
        <div class='tab' onclick='switchTab("editor")'>üîß –†–µ–¥–∞–∫—Ç–æ—Ä –∑–Ω–∞–Ω–∏–π</div>
        <div class='tab' onclick='switchTab("analytics")'>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
      <div class='tab-content active' id='upload'>
        <div class='grid'>
          <div class='card'>
            <div class='card-header'>
              üìö –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∑–Ω–∞–Ω–∏–π
              <span style='background:var(--ok);color:#000;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:700'>–£–õ–£–ß–®–ï–ù–û</span>
            </div>
            <div class='card-body'>
              <form method='post' enctype='multipart/form-data' id='uploadForm'>
                <div class='upload-area' id='uploadArea'>
                  <input type='file' id='trainingFile' name='training_file' accept='.txt,.json,.csv,.md'>
                  <div class='upload-icon'>üß†</div>
                  <div class='upload-text'>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∑–Ω–∞–Ω–∏–π</div>
                  <div class='upload-hint'>
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞<br>
                    <strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</strong> TXT, CSV, JSON, MD<br>
                    <strong>–ö–æ–¥–∏—Ä–æ–≤–∫–∞:</strong> UTF-8, Windows-1251
                  </div>
                </div>

                <button type='submit' name='upload_training_file' class='btn btn-success' style='width:100%;margin-top:12px'>
                  üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±—É—á–∏—Ç—å –ò–ò
                </button>
              </form>
            </div>
          </div>

          <div class='card'>
            <div class='card-header'>üí° –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤</div>
            <div class='card-body'>
              <div class='alert alert-info'>
                <strong>üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (TXT, MD):</strong><br>
                ‚Ä¢ <code>–í–æ–ø—Ä–æ—Å: –û—Ç–≤–µ—Ç</code><br>
                ‚Ä¢ <code>Q: –í–æ–ø—Ä–æ—Å<br>A: –û—Ç–≤–µ—Ç</code><br>
                ‚Ä¢ <code>- –í–æ–ø—Ä–æ—Å<br>- –û—Ç–≤–µ—Ç</code><br><br>

                <strong>üìä CSV —Ñ–∞–π–ª—ã:</strong><br>
                ‚Ä¢ <code>–≤–æ–ø—Ä–æ—Å,–æ—Ç–≤–µ—Ç,–æ—Ü–µ–Ω–∫–∞</code><br>
                ‚Ä¢ <code>–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –≤–∏–∑–∏—Ç–∫–∏?,–û—Ç 900 —Ä—É–±–ª–µ–π,5</code><br><br>

                <strong>üìã JSON —Ñ–∞–π–ª—ã:</strong><br>
                ‚Ä¢ –õ—é–±–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
              </div>

              <div class='knowledge-preview'>
                <strong>üéØ –ì–æ—Ç–æ–≤—ã–µ —Ç–µ–º—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong><br>
                <div class='knowledge-item'>üí∞ –¶–µ–Ω—ã –∏ —Ç–∞—Ä–∏—Ñ—ã</div>
                <div class='knowledge-item'>‚è∞ –°—Ä–æ–∫–∏ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</div>
                <div class='knowledge-item'>üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</div>
                <div class='knowledge-item'>üöö –î–æ—Å—Ç–∞–≤–∫–∞ –∏ —Å–∞–º–æ–≤—ã–≤–æ–∑</div>
                <div class='knowledge-item'>üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
      <div class='tab-content' id='quick'>
        <div class='grid'>
          <div class='card'>
            <div class='card-header'>‚ö° –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π</div>
            <div class='card-body'>
              <form method='post'>
                <div class='form-group'>
                  <label>ü§î –í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞:</label>
                  <input type='text' name='question' placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –≤–∏–∑–∏—Ç–∫–∏?' required>
                </div>

                <div class='form-group'>
                  <label>ü§ñ –û—Ç–≤–µ—Ç –ò–ò:</label>
                  <textarea name='answer' placeholder='–í–∏–∑–∏—Ç–∫–∏ –æ—Ç 900 —Ä—É–±–ª–µ–π –∑–∞ 100 —à—Ç—É–∫ –Ω–∞ –º–µ–ª–æ–≤–∞–Ω–Ω–æ–π –±—É–º–∞–≥–µ. –ì–æ—Ç–æ–≤—ã –∑–∞ 1 –¥–µ–Ω—å.' required></textarea>
                </div>

                <div class='form-group'>
                  <label>üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                  <select name='category'>
                    <option value='prices'>üí∞ –¶–µ–Ω—ã</option>
                    <option value='services'>üõ†Ô∏è –£—Å–ª—É–≥–∏</option>
                    <option value='timeframes'>‚è∞ –°—Ä–æ–∫–∏</option>
                    <option value='technical'>üîß –¢–µ—Ö—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</option>
                    <option value='delivery'>üöö –î–æ—Å—Ç–∞–≤–∫–∞</option>
                    <option value='custom'>üìù –ü—Ä–æ—á–µ–µ</option>
                  </select>
                </div>

                <button type='submit' name='quick_add_knowledge' class='btn btn-accent' style='width:100%'>
                  ‚ö° –î–æ–±–∞–≤–∏—Ç—å –∏ –æ–±—É—á–∏—Ç—å –ò–ò
                </button>
              </form>
            </div>
          </div>

          <div class='card'>
            <div class='card-header'>üéØ –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã</div>
            <div class='card-body'>
              <div class='quick-examples'>
                <div class='example-btn' onclick='fillQuickForm("–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–µ—á–∞—Ç—å –±–∞–Ω–Ω–µ—Ä–∞?", "–ë–∞–Ω–Ω–µ—Ä—ã –æ—Ç 1100 —Ä—É–±–ª–µ–π. –ü–í–• 440 –≥/–º¬≤, –ª—é–≤–µ—Ä—Å—ã –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ. –°—Ä–æ—á–Ω–æ–µ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ 2-4 —á–∞—Å–∞.")'>
                  üí∞ –¶–µ–Ω–∞ –±–∞–Ω–Ω–µ—Ä–∞
                </div>
                <div class='example-btn' onclick='fillQuickForm("–ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ?", "–ü—Ä–∏–Ω–∏–º–∞–µ–º PDF, JPG, PNG, AI, PSD, CDR, EPS. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º PDF –≤ CMYK, 300 dpi —Å –≤—ã–ª–µ—Ç–∞–º–∏ 2-3 –º–º.")'>
                  üìÅ –§–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤
                </div>
                <div class='example-btn' onclick='fillQuickForm("–ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?", "–î–∞, –¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –°–æ—Å–Ω–æ–≤–æ–º—É –ë–æ—Ä—É. –í —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–∞ –æ–∫—Ä–∞–∏–Ω—ã 150-300‚ÇΩ.")'>
                  üöö –î–æ—Å—Ç–∞–≤–∫–∞
                </div>
                <div class='example-btn' onclick='fillQuickForm("–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã?", "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–ø—è—Ç–Ω–∏—Ü–∞ 10:00-20:00, —Å—É–±–±–æ—Ç–∞-–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 11:00-18:00. –ê–¥—Ä–µ—Å: –ö—Ä–∞—Å–Ω—ã—Ö –§–æ—Ä—Ç–æ–≤, 49.")'>
                  üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
                </div>
              </div>

              <div class='alert alert-warning'>
                <strong>üí° –°–æ–≤–µ—Ç:</strong> –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–æ–º –≤–∏–¥–µ, –∫–∞–∫ –∏—Ö –∑–∞–¥–∞—é—Ç –∫–ª–∏–µ–Ω—Ç—ã. –ò–ò –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ—á—å.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ -->
      <div class='tab-content' id='bulk'>
        <div class='card'>
          <div class='card-header'>üìù –ú–∞—Å—Å–æ–≤—ã–π –≤–≤–æ–¥ –∑–Ω–∞–Ω–∏–π</div>
          <div class='card-body'>
            <form method='post'>
              <div class='form-group'>
                <label>üìã –í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã (—Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π):</label>
                <textarea name='bulk_text' style='height:300px' placeholder='–ü—Ä–∏–º–µ—Ä:

–°–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –≤–∏–∑–∏—Ç–∫–∏?
–í–∏–∑–∏—Ç–∫–∏ –æ—Ç 900 —Ä—É–±–ª–µ–π –∑–∞ 100 —à—Ç—É–∫ –Ω–∞ –º–µ–ª–æ–≤–∞–Ω–Ω–æ–π –±—É–º–∞–≥–µ 300 –≥/–º¬≤. –ì–æ—Ç–æ–≤—ã –∑–∞ 1 –¥–µ–Ω—å.

–ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ –ø–µ—á–∞—Ç–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤?
–ë–∞–Ω–Ω–µ—Ä—ã –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞ 2-4 —á–∞—Å–∞. –°—Ä–æ—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–æ 16:00.

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–æ–π?
–î–∞, –ø—Ä–∏–Ω–∏–º–∞–µ–º –æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π. –¢–∞–∫–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –ø–æ –±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–º—É —Ä–∞—Å—á–µ—Ç—É.'></textarea>
              </div>

              <div class='alert alert-info'>
                <strong>üìñ –§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞:</strong><br>
                ‚Ä¢ –ö–∞–∂–¥—ã–π –±–ª–æ–∫ - –æ—Ç–¥–µ–ª—å–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ<br>
                ‚Ä¢ –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –±–ª–æ–∫–∞ - –≤–æ–ø—Ä–æ—Å<br>
                ‚Ä¢ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ - –æ—Ç–≤–µ—Ç<br>
                ‚Ä¢ –†–∞–∑–¥–µ–ª—è–π—Ç–µ –±–ª–æ–∫–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
              </div>

              <button type='submit' name='bulk_add_knowledge' class='btn btn-success' style='width:100%'>
                üìö –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –∑–Ω–∞–Ω–∏—è
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
      <div class='tab-content' id='editor'>
        <div class='card'>
          <div class='card-header'>
            üîß –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
            <button onclick='exportKnowledge()' class='btn' style='padding:6px 12px;font-size:12px'>üíæ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          </div>
          <div class='card-body'>
            <form method='post'>
              <textarea name='knowledge_data' class='knowledge-editor' placeholder='–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ JSON –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π...'><?=json_encode($knowledge, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT)?></textarea>
              <div class='form-group' style='margin-top:12px'>
                <button type='submit' name='update_knowledge' class='btn btn-accent'>
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
                </button>
              </div>
            </form>

            <div class='alert alert-info' style='margin-top:12px'>
              <strong>üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON:</strong><br>
              ‚Ä¢ <code>greetings</code> - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è<br>
              ‚Ä¢ <code>services</code> - –æ–ø–∏—Å–∞–Ω–∏—è —É—Å–ª—É–≥<br>
              ‚Ä¢ <code>prices</code> - —Ü–µ–Ω—ã<br>
              ‚Ä¢ <code>technical_specs</code> - —Ç–µ—Ö—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è<br>
              ‚Ä¢ <code>help</code> - –ø–æ–º–æ—â—å –∏ —Å–æ–≤–µ—Ç—ã<br>
              ‚Ä¢ <code>imported_*</code> - –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            </div>
          </div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
      <div class='tab-content' id='analytics'>
        <div class='grid'>
          <div class='card'>
            <div class='card-header'>üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ò–ò</div>
            <div class='card-body'>
              <?php
              $recentTraining = array_slice($training['conversations'], -30);
              $avgFeedback = 0;
              $totalFeedback = 0;
              foreach ($recentTraining as $conv) {
                if (isset($conv['feedback']) && $conv['feedback'] > 0) {
                  $avgFeedback += $conv['feedback'];
                  $totalFeedback++;
                }
              }
              $avgRating = $totalFeedback > 0 ? round($avgFeedback / $totalFeedback, 1) : 0;
              ?>

              <div class='stat-item' style='margin-bottom:20px'>
                <div class='stat-number'><?=$avgRating?>/5</div>
                <div class='stat-label'>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (30 –¥–∏–∞–ª–æ–≥–æ–≤)</div>
              </div>

              <div class='progress-bar'>
                <div class='progress-fill' style='width:<?=($avgRating/5)*100?>%'></div>
              </div>

              <div class='mini mt-1'>
                –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤: <?=$avgRating >= 4 ? 'üü¢ –û—Ç–ª–∏—á–Ω–æ' : ($avgRating >= 3 ? 'üü° –•–æ—Ä–æ—à–æ' : 'üî¥ –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è')?>
              </div>

              <div style='margin-top:20px'>
                <strong>üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è:</strong>
                <div class='knowledge-preview'>
                  <?php
                  $sources = [];
                  foreach($training['conversations'] as $conv) {
                    $source = $conv['source'] ?? 'unknown';
                    $sources[$source] = ($sources[$source] ?? 0) + 1;
                  }
                  foreach($sources as $source => $count):
                  ?>
                    <div class='knowledge-item'>
                      <?=$source?>: <?=$count?> –∑–∞–ø–∏—Å–µ–π
                    </div>
                  <?php endforeach; ?>
                </div>
              </div>
            </div>
          </div>

          <div class='card'>
            <div class='card-header'>üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏ –ò–ò</div>
            <div class='card-body'>
              <div class='chat-log'>
                <?php if (empty($recentChats)): ?>
                  <div class='text-center muted'>–î–∏–∞–ª–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                <?php else: ?>
                  <?php foreach (array_slice($recentChats, -15) as $chat): ?>
                    <div class='chat-item'>
                      <div class='chat-time'><?=$chat['time']?></div>
                      <div class='chat-user'>üë§ <?=htmlspecialchars($chat['data']['user_message'])?></div>
                      <div class='chat-ai'>ü§ñ <?=htmlspecialchars(mb_substr($chat['data']['ai_response'], 0, 200))?><?=mb_strlen($chat['data']['ai_response']) > 200 ? '...' : ''?></div>
                    </div>
                  <?php endforeach; ?>
                <?php endif; ?>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏–µ–º -->
    <div class='grid' style='margin-top:20px'>
      <div class='card'>
        <div class='card-header'>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏–µ–º</div>
        <div class='card-body'>
          <div class='form-group'>
            <strong>üß† –í—ã—É—á–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:</strong>
            <div class='knowledge-preview'>
              <?php foreach (array_slice($training['learning_patterns'], 0, 15, true) as $pattern => $responses): ?>
                <div class='knowledge-item'>
                  <strong><?=htmlspecialchars($pattern)?>:</strong> <?=count($responses)?> –æ—Ç–≤–µ—Ç–æ–≤
                </div>
              <?php endforeach; ?>
            </div>
          </div>

          <form method='post' onsubmit='return confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!")'>
            <button type='submit' name='reset_training' class='btn btn-danger'>
              üóëÔ∏è –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –æ–±—É—á–µ–Ω–∏—è –ò–ò
            </button>
          </form>
        </div>
      </div>

      <div class='card'>
        <div class='card-header'>üéØ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
        <div class='card-body'>
          <div class='knowledge-preview'>
            <strong>üìö –†–∞–∑–¥–µ–ª—ã –∑–Ω–∞–Ω–∏–π (<?=count($knowledge)?>):</strong><br>
            <?php foreach($knowledge as $section => $data): ?>
              <div class='knowledge-item'>
                <?=htmlspecialchars($section)?>: <?=is_array($data) ? count($data) : 1?> –∑–∞–ø–∏—Å–µ–π
              </div>
            <?php endforeach; ?>
          </div>

          <div style='margin-top:16px'>
            <a href='index.php' class='btn btn-accent'>‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
            <button onclick='location.reload()' class='btn'>üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          </div>
        </div>
      </div>
    </div>

    <div style='margin-top:30px;text-align:center;padding:20px;background:var(--panel);border-radius:8px;border:1px solid var(--border)'>
      <strong>ü§ñ AI Admin Panel v2.1 - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</strong><br>
      <span class='mini'>–£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Ä¢ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ ‚Ä¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã ‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
    </div>
  </div>

  <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–π —Ñ–æ—Ä–º—ã
    function fillQuickForm(question, answer) {
      document.querySelector('input[name="question"]').value = question;
      document.querySelector('textarea[name="answer"]').value = answer;

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      switchTab('quick');
      document.querySelectorAll('.tab')[1].classList.add('active');
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    function exportKnowledge() {
      const knowledge = document.querySelector('.knowledge-editor').value;
      const blob = new Blob([knowledge], {type: 'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ai_knowledge_backup_' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Drag & Drop –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('trainingFile');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.add('dragover');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.remove('dragover');
      }, false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        updateFileInfo(files[0]);
      }
    }, false);

    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        updateFileInfo(e.target.files[0]);
      }
    });

    function updateFileInfo(file) {
      const uploadText = uploadArea.querySelector('.upload-text');
      const uploadHint = uploadArea.querySelector('.upload-hint');

      uploadText.textContent = `üìÅ ${file.name}`;
      uploadHint.innerHTML = `–†–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)} KB<br>–ì–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ!`;

      uploadArea.style.borderColor = 'var(--ok)';
      uploadArea.style.background = 'linear-gradient(135deg,rgba(74,222,128,.05),rgba(45,91,255,.05))';
    }

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    let saveTimeout;
    document.querySelector('.knowledge-editor')?.addEventListener('input', function() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        localStorage.setItem('ai_knowledge_draft', this.value);
        console.log('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      }, 2000);
    });

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    window.addEventListener('load', function() {
      const draft = localStorage.getItem('ai_knowledge_draft');
      const editor = document.querySelector('.knowledge-editor');
      if (draft && editor && !editor.value.trim()) {
        if (confirm('–ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?')) {
          editor.value = draft;
        }
      }
    });

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      if (document.getElementById('analytics').classList.contains('active')) {
        location.reload();
      }
    }, 30000);
  </script>
</body>
</html>
